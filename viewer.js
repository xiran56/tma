function v(e,t){let o=e.length;for(let n=t+1;n<o;++n)e[n-1]=e[n];e.length=o-1}function x(e,t,o){for(let n=e.length;n>t;--n)e[n]=e[n-1];e[t]=o}function z(e,t){let o=0,n=e.length-1;for(;o<=n;){let i=o+n>>1,a=e[i];if(t<a)n=i-1;else if(t>a)o=i+1;else return!0}return!1}function E(e,t){let o=0,n=e.length-1;for(;o<=n;){let i=o+n>>1,a=e[i];if(t<a)n=i-1;else if(t>a)o=i+1;else return}x(e,o,t)}function k(e,t){let o=0,n=e.length-1;for(;o<=n;){let i=o+n>>1,a=e[i];if(t<a)n=i-1;else if(t>a)o=i+1;else{v(e,i);return}}}function g(e){document.getElementById("message").textContent=e}function f(){document.getElementById("message").textContent=""}function u(e){for(let t of document.querySelectorAll("header > details"))t!==e&&t.removeAttribute("open")}for(let e of document.querySelectorAll("header > details"))e.addEventListener("click",function(){u(e)});for(let e of document.querySelectorAll("header > details > menu"))e.addEventListener("click",function(){u(null)});window.addEventListener("mousedown",function(e){let t=e.target;for(;t;){if(t.tagName==="DETAILS")return;t=t.parentElement}u(null)});window.addEventListener("blur",function(){u(null)});var s=new Worker("worker.js",{type:"module"});s._promise_id=1;s._promise_map=new Map;s.wrap=function(e){return function(...t){return new Promise(function(o,n){let i=s._promise_id++;s._promise_map.set(i,{resolve:o,reject:n}),t[0]instanceof ArrayBuffer?s.postMessage([e,i,t],[t[0]]):s.postMessage([e,i,t])})}};s.onmessage=function(e){let[t,o,n]=e.data,i;switch(t){case"INIT":for(let a of n)s[a]=s.wrap(a);P();break;case"RESULT":s._promise_map.get(o).resolve(n),s._promise_map.delete(o);break;case"ERROR":i=new Error(n.message),i.name=n.name,i.stack=n.stack,s._promise_map.get(o).reject(i),s._promise_map.delete(o);break;default:i=new Error(`Invalid message: ${t}`),s._promise_map.get(o).reject(i);break}};var h=class{constructor(t,o,n,i){this.doc=t,this.pageNumber=o,this.size=n,this.loadPromise=!1,this.drawPromise=!1,this.rootNode=document.createElement("div"),this.rootNode.id="page"+(o+1),this.rootNode.className="page",this.rootNode.page=this,this.canvasNode=document.createElement("canvas"),this.canvasCtx=this.canvasNode.getContext("2d"),this.rootNode.appendChild(this.canvasNode),this.textData=null,this.textNode=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.textNode.classList.add("text"),this.rootNode.appendChild(this.textNode),this.linkData=null,this.linkNode=document.createElement("div"),this.linkNode.className="link",this.rootNode.appendChild(this.linkNode),this.zoom=i,this._updateSize()}_updateSize(){this.rootNode.style.width=(this.size.width*this.zoom/72|0)+"px",this.rootNode.style.height=(this.size.height*this.zoom/72|0)+"px",this.canvasNode.style.width=(this.size.width*this.zoom/72|0)+"px",this.canvasNode.style.height=(this.size.height*this.zoom/72|0)+"px"}setZoom(t){this.zoom!==t&&(this.zoom=t,this._updateSize())}async _load(){console.log("LOADING",this.pageNumber),this.size=await s.getPageSize(this.doc,this.pageNumber),this.textData=await s.getPageText(this.doc,this.pageNumber),this.linkData=await s.getPageLinks(this.doc,this.pageNumber),this._updateSize()}async _show(){this.loadPromise||(this.loadPromise=this._load()),await this.loadPromise,this.canvasNode.zoom!==this.zoom&&this._render(),this.textNode.zoom!==this.zoom&&this._showText(),this.linkNode.zoom!==this.zoom&&this._showLinks()}async _render(){let t=this.zoom;if(this.canvasNode.zoom===this.zoom)return;if(this.drawPromise){console.log("BUSY DRAWING",this.pageNumber);return}console.log("DRAWING",this.pageNumber,t),this.canvasNode.zoom=this.zoom,this.drawPromise=s.drawPageAsPixmap(this.doc,this.pageNumber,t*devicePixelRatio);let o=await this.drawPromise;o!=null&&(this.drawPromise=null,this.zoom===t?(console.log("FRESH IMAGE",this.pageNumber),this.canvasNode.width=o.width,this.canvasNode.height=o.height,this.canvasCtx.putImageData(o,0,0)):(console.log("STALE IMAGE",this.pageNumber),z(c,this.pageNumber)&&this._render()))}_showText(){let t=document.createDocumentFragment(),o=this.zoom/72;for(let n of this.textData.blocks)if(n.type==="text")for(let i of n.lines){let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",i.bbox.x*o+"px"),a.setAttribute("y",i.y*o+"px"),a.style.fontSize=i.font.size*o+"px",a.style.fontFamily=i.font.family,a.style.fontWeight=i.font.weight,a.style.fontStyle=i.font.style,a.setAttribute("textLength",i.bbox.w*o+"px"),a.setAttribute("lengthAdjust","spacingAndGlyphs"),a.textContent=i.text,t.appendChild(a)}this.textNode.zoom=this.zoom,this.textNode.replaceChildren(t)}_showLinks(){this.linkNode.zoom=this.zoom,this.linkNode.replaceChildren();let t=this.zoom/72;for(let o of this.linkData){let n=document.createElement("a");n.href=o.href,n.style.left=o.x*t+"px",n.style.top=o.y*t+"px",n.style.width=o.w*t+"px",n.style.height=o.h*t+"px",this.linkNode.appendChild(n)}}},r=0,d=96,l=null,c=[],w=new IntersectionObserver(function(e){for(let t of e){let o=t.target.page;t.isIntersecting?E(c,o.pageNumber):k(c,o.pageNumber)}_()},{root:document.getElementById("page-panel"),rootMargin:"25% 0px 300% 0px"}),m=0;function _(){m&&clearTimeout(m),m=setTimeout(A,50)}function A(){m&&clearTimeout(m),m=0;for(let e of c)l[e]._show()}function C(){let e=document.getElementById("page-panel").getBoundingClientRect(),t=(e.top+e.bottom)/2;for(let o of c){let n=l[o].rootNode.getBoundingClientRect();if(n.top<=t&&n.bottom>=t)return o}return c[0]}function N(){p(Math.min(d+12,384))}function b(){p(Math.max(d-12,48))}function p(e){if(d===e)return;d=e;let t=C();for(let o of l)o.setZoom(d);l[t].rootNode.scrollIntoView(),_()}window.addEventListener("wheel",function(e){(e.ctrlKey||e.metaKey)&&(e.deltaY<0?N():e.deltaY>0&&b(),e.preventDefault())},{passive:!1});window.addEventListener("keydown",function(e){if(e.ctrlKey||e.metaKey)switch(e.keyCode){case 61:case 107:case 187:case 171:N(),e.preventDefault();break;case 173:case 109:case 189:b(),e.preventDefault();break;case 48:case 96:p(100);break;case 65:document.getSelection().selectAllChildren(document.getElementById("pages")),e.preventDefault();break}});function y(e){document.getElementById("pages").classList.remove("do-content-select"),document.removeEventListener("mouseup",y)}document.addEventListener("selectstart",function(e){document.getElementById("pages").classList.add("do-content-select"),document.addEventListener("mouseup",y)});function I(){if(f(),r){s.closeDocument(r),r=0,document.getElementById("pages").replaceChildren();for(let e of l)w.unobserve(e.rootNode);c.length=0}l=null}async function S(e){document.title=await s.documentTitle(r)||e;var t=await s.countPages(r),o=await s.getPageSize(r,t>1?1:0);l=[];for(let n=0;n<t;++n)l[n]=new h(r,n,o,d);for(let n of l)document.getElementById("pages").appendChild(n.rootNode),w.observe(n.rootNode);f()}async function L(e,t,o){r=await s.openDocumentFromBuffer(e,t),await S(o)}async function D(e){I();try{g("\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430...");let t=await fetch(e);if(!t.ok)throw new Error("Could not fetch document.");await L(await t.arrayBuffer(),e,e)}catch(t){g(t.name+": "+t.message),console.error(t)}}function P(){f(),Telegram.WebApp.ready(),Telegram.WebApp.onEvent("themeChanged",function(){document.documentElement.className=Telegram.WebApp.colorScheme,document.body.setAttribute("style","--bg-color:"+Telegram.WebApp.backgroundColor)});let e=new URLSearchParams(window.location.search);e.has("file")&&D(e.get("file"))}

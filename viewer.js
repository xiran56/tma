function A(e,t){let o=e.length;for(let s=t+1;s<o;++s)e[s-1]=e[s];e.length=o-1}function B(e,t,o){for(let s=e.length;s>t;--s)e[s]=e[s-1];e[t]=o}function L(e,t){let o=0,s=e.length-1;for(;o<=s;){let n=o+s>>1,a=e[n];if(t<a)s=n-1;else if(t>a)o=n+1;else return!0}return!1}function P(e,t){let o=0,s=e.length-1;for(;o<=s;){let n=o+s>>1,a=e[n];if(t<a)s=n-1;else if(t>a)o=n+1;else return}B(e,o,t)}function T(e,t){let o=0,s=e.length-1;for(;o<=s;){let n=o+s>>1,a=e[n];if(t<a)s=n-1;else if(t>a)o=n+1;else{A(e,n);return}}}function x(e){document.getElementById("message").textContent=e}function _(){document.getElementById("message").textContent=""}function g(e){for(let t of document.querySelectorAll("header > details"))t!==e&&t.removeAttribute("open")}for(let e of document.querySelectorAll("header > details"))e.addEventListener("click",function(){g(e)});for(let e of document.querySelectorAll("header > details > menu"))e.addEventListener("click",function(){g(null)});window.addEventListener("mousedown",function(e){let t=e.target;for(;t;){if(t.tagName==="DETAILS")return;t=t.parentElement}g(null)});window.addEventListener("blur",function(){g(null)});var i=new Worker("worker.js",{type:"module"});i._promise_id=1;i._promise_map=new Map;i.wrap=function(e){return function(...t){return new Promise(function(o,s){let n=i._promise_id++;i._promise_map.set(n,{resolve:o,reject:s}),t[0]instanceof ArrayBuffer?i.postMessage([e,n,t],[t[0]]):i.postMessage([e,n,t])})}};i.onmessage=function(e){let[t,o,s]=e.data,n;switch(t){case"INIT":for(let a of s)i[a]=i.wrap(a);K();break;case"RESULT":i._promise_map.get(o).resolve(s),i._promise_map.delete(o);break;case"ERROR":n=new Error(s.message),n.name=s.name,n.stack=s.stack,i._promise_map.get(o).reject(n),i._promise_map.delete(o);break;default:n=new Error(`Invalid message: ${t}`),i._promise_map.get(o).reject(n);break}};var w=class{constructor(t,o,s,n){this.doc=t,this.pageNumber=o,this.size=s,this.loadPromise=!1,this.drawPromise=!1,this.rootNode=document.createElement("div"),this.rootNode.id="page"+(o+1),this.rootNode.className="page",this.rootNode.page=this,this.canvasNode=document.createElement("canvas"),this.canvasCtx=this.canvasNode.getContext("2d"),this.rootNode.appendChild(this.canvasNode),this.textData=null,this.textNode=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.textNode.classList.add("text"),this.rootNode.appendChild(this.textNode),this.linkData=null,this.linkNode=document.createElement("div"),this.linkNode.className="link",this.rootNode.appendChild(this.linkNode),this.needle=null,this.loadNeedle=null,this.showNeedle=null,this.searchData=null,this.searchNode=document.createElement("div"),this.searchNode.className="search",this.rootNode.appendChild(this.searchNode),this.zoom=n,this._updateSize()}_updateSize(){this.rootNode.style.width=(this.size.width*this.zoom/72|0)+"px",this.rootNode.style.height=(this.size.height*this.zoom/72|0)+"px",this.canvasNode.style.width=(this.size.width*this.zoom/72|0)+"px",this.canvasNode.style.height=(this.size.height*this.zoom/72|0)+"px"}setZoom(t){this.zoom!==t&&(this.zoom=t,this._updateSize())}setSearch(t){this.needle!==t&&(this.needle=t)}async _load(){console.log("LOADING",this.pageNumber),this.size=await i.getPageSize(this.doc,this.pageNumber),this.textData=await i.getPageText(this.doc,this.pageNumber),this.linkData=await i.getPageLinks(this.doc,this.pageNumber),this._updateSize()}async _loadSearch(){this.loadNeedle!==this.needle&&(this.loadNeedle=this.needle,this.needle?this.searchData=await i.search(this.doc,this.pageNumber,this.needle):this.searchData=null)}async _show(){this.loadPromise||(this.loadPromise=this._load()),await this.loadPromise,this.canvasNode.zoom!==this.zoom&&this._render(),this.textNode.zoom!==this.zoom&&this._showText(),this.linkNode.zoom!==this.zoom&&this._showLinks(),this.loadNeedle!==this.needle&&await this._loadSearch(),(this.showNeedle!==this.needle||this.searchNode.zoom!==this.zoom)&&this._showSearch()}async _render(){let t=this.zoom;if(this.canvasNode.zoom===this.zoom)return;if(this.drawPromise){console.log("BUSY DRAWING",this.pageNumber);return}console.log("DRAWING",this.pageNumber,t),this.canvasNode.zoom=this.zoom,this.drawPromise=i.drawPageAsPixmap(this.doc,this.pageNumber,t*devicePixelRatio);let o=await this.drawPromise;o!=null&&(this.drawPromise=null,this.zoom===t?(console.log("FRESH IMAGE",this.pageNumber),this.canvasNode.width=o.width,this.canvasNode.height=o.height,this.canvasCtx.putImageData(o,0,0)):(console.log("STALE IMAGE",this.pageNumber),L(c,this.pageNumber)&&this._render()))}_showText(){let t=document.createDocumentFragment(),o=this.zoom/72;for(let s of this.textData.blocks)if(s.type==="text")for(let n of s.lines){let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",n.bbox.x*o+"px"),a.setAttribute("y",n.y*o+"px"),a.style.fontSize=n.font.size*o+"px",a.style.fontFamily=n.font.family,a.style.fontWeight=n.font.weight,a.style.fontStyle=n.font.style,a.setAttribute("textLength",n.bbox.w*o+"px"),a.setAttribute("lengthAdjust","spacingAndGlyphs"),a.textContent=n.text,t.appendChild(a)}this.textNode.zoom=this.zoom,this.textNode.replaceChildren(t)}_showLinks(){this.linkNode.zoom=this.zoom,this.linkNode.replaceChildren();let t=this.zoom/72;for(let o of this.linkData){let s=document.createElement("a");s.href=o.href,s.style.left=o.x*t+"px",s.style.top=o.y*t+"px",s.style.width=o.w*t+"px",s.style.height=o.h*t+"px",this.linkNode.appendChild(s)}}_showSearch(){if(this.showNeedle=this.needle,this.searchNode.zoom=this.zoom,this.searchNode.replaceChildren(),this.searchData){let t=this.zoom/72;for(let o of this.searchData){let s=document.createElement("div");s.style.left=o.x*t+"px",s.style.top=o.y*t+"px",s.style.width=o.w*t+"px",s.style.height=o.h*t+"px",this.searchNode.appendChild(s)}}}},r=0,h=96,l=null,c=[],v=new IntersectionObserver(function(e){for(let t of e){let o=t.target.page;t.isIntersecting?P(c,o.pageNumber):T(c,o.pageNumber)}N()},{root:document.getElementById("page-panel"),rootMargin:"25% 0px 300% 0px"}),d=0;function N(){d&&clearTimeout(d),d=setTimeout(R,50)}function R(){d&&clearTimeout(d),d=0;for(let e of c)l[e]._show()}function E(){let e=document.getElementById("page-panel").getBoundingClientRect(),t=(e.top+e.bottom)/2;for(let o of c){let s=l[o].rootNode.getBoundingClientRect();if(s.top<=t&&s.bottom>=t)return o}return c[0]}function z(){y(Math.min(h+12,384))}function k(){y(Math.max(h-12,48))}function y(e){if(h===e)return;h=e;let t=E();for(let o of l)o.setZoom(h);l[t].rootNode.scrollIntoView(),N()}window.addEventListener("wheel",function(e){(e.ctrlKey||e.metaKey)&&(e.deltaY<0?z():e.deltaY>0&&k(),e.preventDefault())},{passive:!1});window.addEventListener("keydown",function(e){if(e.ctrlKey||e.metaKey)switch(e.keyCode){case 61:case 107:case 187:case 171:z(),e.preventDefault();break;case 173:case 109:case 189:k(),e.preventDefault();break;case 48:case 96:y(100);break;case 65:document.getSelection().selectAllChildren(document.getElementById("pages")),e.preventDefault();break;case 70:b(),e.preventDefault();break;case 71:b(),F(e.shiftKey?-1:1,1),e.preventDefault();break}e.key==="Escape"&&D()});function C(e){document.getElementById("pages").classList.remove("do-content-select"),document.removeEventListener("mouseup",C)}document.addEventListener("selectstart",function(e){document.getElementById("pages").classList.add("do-content-select"),document.addEventListener("mouseup",C)});var S=document.getElementById("search-panel"),u=document.getElementById("search-status"),m=document.getElementById("search-input"),p="",f=-1;m.onchange=function(e){f=-1};m.onkeyup=function(e){e.key==="Enter"&&(e.shiftKey?document.getElementById("search-prev").click():document.getElementById("search-next").click())};function b(){l&&(S.style.display="",m.focus(),m.select())}function D(){S.style.display="none",m.value="",I("")}function I(e){if(u.textContent="",p=e,!!l){for(let t of l)t.setSearch(p);N()}}async function F(e,t){I(m.value);let o=0;for(f===-1?o=E():(o=f,t&&(o+=e));o>=0&&o<l.length;){if(p===""){u.textContent="";return}u.textContent=`Searching page ${o+1}.`,l[o].loadNeedle!==l[o].needle&&await l[o]._loadSearch();let s=l[o].searchData;if(s&&s.length>0){l[o].rootNode.scrollIntoView(),f=o;let n=s.length===1?"hit":"hits";u.textContent=`${s.length} ${n} on page ${o+1}.`;return}o+=e}u.textContent="No more search hits."}function M(){if(_(),D(),r){i.closeDocument(r),r=0,document.getElementById("pages").replaceChildren();for(let e of l)v.unobserve(e.rootNode);c.length=0}l=null}async function W(e){document.title=await i.documentTitle(r)||e;var t=await i.countPages(r),o=await i.getPageSize(r,t>1?1:0);l=[];for(let s=0;s<t;++s)l[s]=new w(r,s,o,h);for(let s of l)document.getElementById("pages").appendChild(s.rootNode),v.observe(s.rootNode);_(),p="",f=-1}async function q(e,t,o){r=await i.openDocumentFromBuffer(e,t),await W(o)}async function G(e){M();try{x("\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430...");let t=await fetch(e);if(!t.ok)throw new Error("Could not fetch document.");await q(await t.arrayBuffer(),e,e)}catch(t){x(t.name+": "+t.message),console.error(t)}}function K(){_(),Telegram.WebApp.ready(),Telegram.WebApp.onEvent("themeChanged",function(){document.documentElement.className=Telegram.WebApp.colorScheme,document.body.setAttribute("style","--bg-color:"+Telegram.WebApp.backgroundColor)});let e=new URLSearchParams(window.location.search);e.has("file")&&G(e.get("file"))}
